<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>学校食谱</title>
    <style>
        .watermark {
            position: fixed;
            bottom: 20px;
            right: 20px;
            font-family: 'Orbitron', sans-serif;
            color: #64ffda;
            font-size: 16px;
            z-index: 9999;
            text-shadow: 0 0 5px #64ffda;
            opacity: 0.8;
            letter-spacing: 2px;
            pointer-events: none; /* 防止文字影响页面交互 */
            animation: glow 2 ease-in-out infinite alternate;
        }
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            padding: 50px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
        }
        .status {
            margin: 20px 0;
            padding: 15px;
            border-radius: 5px;
        }
        .loading {
            background-color: #e6f7ff;
            color: #0066cc;
        }
        .error {
            background-color: #fff2f0;
            color: #ff4d4f;
        }
        .school-select button {
            display: block;
            width: 80%;
            margin: 10px auto;
            padding: 10px;
            background-color: #1890ff;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .school-select button:hover {
            background-color: #40a9ff;
        }
        #countdown {
            margin-top: 20px;
            color: #666;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>学校食谱选择界面</h1>
        <h2>定位系统</h2>
        <div id="status" class="status loading">
            正在获取位置信息...<br><small>这通常需要5-8秒时间，请给予位置权限。</small>
        </div>
        <div id="timeout-message" class="status error" style="display:none;">
            位置获取超时，3秒后自动重试...
        </div>
        <div id="school-select" class="school-select" style="display:none;">
            <h3>请选择学校：</h3>
            <div id="location-info">
                <p>当前位置：<span id="address">获取中...</span></p>
                <p>经纬度：<span id="coordinates">获取中...</span></p>
            </div>
            <div id="school-list"></div>
            <div id="countdown" style="display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 10px;">
                <span id="countdown-text">3秒后自动跳转推荐学校</span>
                <button id="cancel-redirect" style="padding: 5px 15px; background-color: #f0f0f0; border: 1px solid #ccc; border-radius: 3px; cursor: pointer;">
                    取消跳转
                </button>
            </div>
        </div>
    </div>

    <script>
        // 学校数据存储
        const SCHOOLS = [
            {
                name: "杭州市景汇中学",
                lat: 30.1234,
                lng: 120.1234,
                redirect: "JingHuiZhongXueShiPu.html"
            },
            // 可以在此添加更多学校数据
            /*
            {
                name: "示例学校",
                lat: 30.5678,
                lng: 120.5678,
                redirect: "example.html"
            }
            */
        ];

        // 反向地理编码获取地址（使用高德地图API）
        async function getAddress(lat, lon) {
            try {
                console.log('开始获取地址...');
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000);
                
                const response = await fetch(
                    `https://restapi.amap.com/v3/geocode/regeo?key=818c3c1c32fd4afb0d418ca4f0a47395&location=${lon},${lat}&extensions=base`,
                    { signal: controller.signal }
                );
                
                clearTimeout(timeoutId);
                
                if (!response.ok) {
                    console.error('API请求失败:', response.status);
                    return 'API请求失败';
                }
                
                const data = await response.json();
                console.log('API响应:', data);
                
                if (data.status !== '1' || !data.regeocode) {
                    console.warn('未找到地址信息:', data.info || '未知错误');
                    return '地址信息不可用';
                }
                
                // 返回格式化地址
                return data.regeocode.formatted_address || '未知位置';
            } catch (error) {
                console.error('获取地址失败:', error);
                if (error.name === 'AbortError') {
                    return '请求超时';
                }
                return '获取地址失败';
            }
        }
        
        // 查找距离最近的学校
        function findNearestSchool(userLat, userLng) {
            let nearest = null;
            let minDistance = Infinity;
            
            for (const school of SCHOOLS) {
                const distance = calculateDistance(
                    userLat, userLng,
                    school.lat, school.lng
                );
                
                if (distance < minDistance) {
                    minDistance = distance;
                    nearest = school;
                }
            }
            
            return {
                school: nearest,
                distance: minDistance
            };
        }
        
        // 页面加载时获取位置
        window.onload = function() {
            const statusEl = document.getElementById('status');
            const timeoutMsg = document.getElementById('timeout-message');
            const schoolSelect = document.getElementById('school-select');
            const schoolList = document.getElementById('school-list');
            const countdownEl = document.getElementById('countdown');
            
            // 设置超时自动刷新
            const timeoutId = setTimeout(() => {
                statusEl.style.display = 'none';
                timeoutMsg.style.display = 'block';
                setTimeout(() => {
                    location.reload();
                }, 3000);
            }, 10000);
            
            // 填充学校列表
            function populateSchoolList() {
                schoolList.innerHTML = '';
                SCHOOLS.forEach(school => {
                    const btn = document.createElement('button');
                    btn.textContent = school.name;
                    btn.onclick = () => {
                        clearTimeout(timeoutId);
                        clearTimeout(countdownTimer);
                        window.location.href = school.redirect;
                    };
                    schoolList.appendChild(btn);
                });
            }
            
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        // 获取成功
                        const userLat = position.coords.latitude;
                        const userLng = position.coords.longitude;
                        
                        // 调试信息
                        console.log("用户位置:", userLat, userLng);
                        
                        // 查找最近的学校
                        const result = findNearestSchool(userLat, userLng);
                        const nearestSchool = result.school;
                        const distance = result.distance;
                        
                        if (nearestSchool) {
                            clearTimeout(timeoutId);
                            statusEl.style.display = 'none';
                            schoolSelect.style.display = 'block';
                            
                            // 显示经纬度
                            document.getElementById('coordinates').textContent = 
                                `${position.coords.latitude.toFixed(6)}, ${position.coords.longitude.toFixed(6)}`;
                            
                            // 获取地址信息
                            getAddress(position.coords.latitude, position.coords.longitude)
                                .then(address => {
                                    document.getElementById('address').textContent = address || '未知位置';
                                })
                                .catch(() => {
                                    document.getElementById('address').textContent = '获取地址失败';
                                });
                            
                            populateSchoolList();
                            
                            // 3秒倒计时自动跳转
                            let seconds = 3;
                            let countdownTimer;
                            
                            function updateCountdown() {
                                document.getElementById('countdown-text').textContent = 
                                    `${seconds}秒后自动跳转${nearestSchool.name}`;
                                seconds--;
                                if (seconds < 0) {
                                    clearInterval(countdownTimer);
                                    window.location.href = nearestSchool.redirect;
                                }
                            }
                            
                            countdownTimer = setInterval(updateCountdown, 1000);
                            updateCountdown(); // 立即执行一次
                            
                            // 取消按钮事件
                            document.getElementById('cancel-redirect').addEventListener('click', () => {
                                clearInterval(countdownTimer);
                                document.getElementById('countdown-text').textContent = '已取消自动跳转';
                                document.getElementById('cancel-redirect').style.display = 'none';
                            });
                        } else {
                            statusEl.className = "status error";
                            statusEl.innerHTML = "未找到可跳转的学校";
                            console.log("学校数据为空");
                        }
                    },
                    function(error) {
                        // 获取失败
                        statusEl.className = "status error";
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                statusEl.innerHTML = "请允许位置访问权限：<br>1. 点击地址栏中的锁图标<br>2. 选择'网站设置'<br>3. 将'位置'权限改为'允许'";
                                console.error("位置权限被拒绝:", error);
                                break;
                            case error.POSITION_UNAVAILABLE:
                                statusEl.innerHTML = "无法获取位置信息：<br>请确保已开启GPS或位置服务<br>并检查网络连接";
                                console.error("位置信息不可用:", error);
                                break;
                            case error.TIMEOUT:
                                statusEl.innerHTML = "获取位置超时：<br>可能由于信号弱导致<br>请刷新页面重试";
                                console.error("位置请求超时:", error);
                                break;
                            case error.UNKNOWN_ERROR:
                                statusEl.innerHTML = "系统错误：<br>请稍后重试或联系管理员";
                                console.error("未知位置错误:", error);
                                break;
                        }
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 8000,  // 缩短超时时间到8秒
                        maximumAge: 0
                    }
                );
            } else {
                statusEl.className = "status error";
                statusEl.innerHTML = "您的浏览器不支持地理位置功能";
            }
        };
        
        // 计算两个经纬度坐标之间的距离（Haversine公式）
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // 地球半径（公里）
            const dLat = deg2rad(lat2 - lat1);
            const dLon = deg2rad(lon2 - lon1);
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * 
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            const distance = R * c; // 距离（公里）
            return distance;
        }
        
        function deg2rad(deg) {
            return deg * (Math.PI/180);
        }
    </script>
        <div class="watermark">Ryokuryuneko</div>
        <div style="text-align: center; margin-top: 20px; font-size: 12px; color: #666;">
            版权所有 © Ryokuryuneko
        </div>
    </body>
</html>
